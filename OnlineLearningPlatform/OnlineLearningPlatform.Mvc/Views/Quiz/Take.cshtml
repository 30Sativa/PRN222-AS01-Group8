@model OnlineLearningPlatform.Models.Entities.Quiz
@{
    ViewData["Title"] = "Làm bài Quiz";
    var questionCount = Model.Questions.Count();
    var questionIndex = 0;
}

<link rel="stylesheet" href="~/css/Quiz/quiz.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

<div class="quiz-container">
    <div class="quiz-header">
        <h2><i class="bi bi-journal-check me-2"></i>@Model.Title</h2>
        <div class="quiz-meta">
            <div class="quiz-meta-item">
                <i class="bi bi-question-circle"></i>
                <span>@questionCount câu hỏi</span>
            </div>
            <div class="quiz-meta-item">
                <i class="bi bi-clock"></i>
                <span>Không giới hạn thời gian</span>
            </div>
        </div>
    </div>

    <div class="quiz-body">
        <div class="quiz-progress">
            <span class="progress-text">Tiến độ</span>
            <div class="progress-bar-wrapper">
                <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <span class="progress-text" id="progressText">0/@questionCount</span>
        </div>

        <form asp-action="Submit" method="post" id="quizForm">
            <input type="hidden" name="quizId" value="@Model.QuizId" />

            @foreach (var q in Model.Questions)
            {
                questionIndex++;
                var answers = q.QuizAnswers.Where(x => x.AttemptId == null).ToList();

                <div class="question-card" data-question="@questionIndex">
                    <div class="question-text">
                        <span class="question-number">@questionIndex</span>
                        <span class="question-content">@q.Content</span>
                    </div>
                    <div class="answer-options">
                        @foreach (var a in answers)
                        {
                            <label class="answer-option" onclick="selectAnswer(this, @questionIndex)">
                                <input type="radio" name="q_@q.QuestionId" value="@a.UserAnswer" required>
                                <span class="radio-custom"></span>
                                <span class="answer-label">@a.UserAnswer</span>
                            </label>
                        }
                    </div>
                </div>
            }

            <button type="submit" class="quiz-submit-btn">
                <i class="bi bi-send-fill"></i>
                NỘP BÀI
            </button>
        </form>
    </div>
</div>

<script>
    const totalQuestions = @questionCount;
    let answeredQuestions = new Set();

    function selectAnswer(element, questionNumber) {
        // Remove selected class from siblings
        const parent = element.closest('.answer-options');
        parent.querySelectorAll('.answer-option').forEach(opt => {
            opt.classList.remove('selected');
        });

        // Add selected class to clicked option
        element.classList.add('selected');

        // Update progress
        answeredQuestions.add(questionNumber);
        updateProgress();
    }

    function updateProgress() {
        const answered = answeredQuestions.size;
        const percentage = (answered / totalQuestions) * 100;
        
        document.getElementById('progressBar').style.width = percentage + '%';
        document.getElementById('progressText').textContent = answered + '/' + totalQuestions;
    }

    // Confirm before submit
    document.getElementById('quizForm').addEventListener('submit', function(e) {
        const unanswered = totalQuestions - answeredQuestions.size;
        if (unanswered > 0) {
            if (!confirm(`Bạn còn ${unanswered} câu chưa trả lời. Bạn có chắc muốn nộp bài?`)) {
                e.preventDefault();
            }
        } else {
            if (!confirm('Bạn có chắc chắn muốn nộp bài?')) {
                e.preventDefault();
            }
        }
    });
</script>
